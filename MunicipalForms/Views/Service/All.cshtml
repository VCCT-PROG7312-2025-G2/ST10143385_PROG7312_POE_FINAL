@{
    ViewData["Title"] = "All Submitted Requests";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        <!-- fixing my scrollable -->
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .page-container {
            height: 100vh;
            overflow-y: auto;
            padding: 1.5rem;
            background: #f8f9fa;
            -webkit-overflow-scrolling: touch;
        }

        .card {
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .table thead {
            background: #1a1a2e;
            color: #fff;
        }

        .table th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        .empty-state {
            color: #6c757d;
            font-style: italic;
            font-size: 1.1rem;
        }

        code {
            background: #e9ecef;
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.85rem;
        }

        .btn-back, .btn-clear {
            border-radius: 0.5rem;
            font-weight: 500;
        }

        .filter-controls {
            background: #fff;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <a href="/" class="btn btn-outline-secondary btn-back">Back to Dashboard</a>
            <a href="/Service/Index" class="btn btn-primary btn-back">Submit New</a>
        </div>

        <h3 class="fw-bold text-primary mb-3">All Submitted Requests</h3>

        <!-- filter -->
        <div class="filter-controls">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <label class="form-label small text-muted mb-1">Filter by Category</label>
                    <select class="form-select form-select-sm" id="filterCategory">
                        <option value="">All Categories</option>
                        <option>Public Safety</option>
                        <option>Roads & Potholes</option>
                        <option>Water & Sanitation</option>
                        <option>Electricity</option>
                        <option>Waste Management</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted mb-1">Filter by Priority</label>
                    <select class="form-select form-select-sm" id="filterPriority">
                        <option value="">All Priorities</option>
                        <option value="1">1 - Emergency</option>
                        <option value="2">2 - Urgent</option>
                        <option value="3">3 - Medium</option>
                        <option value="4">4 - Low</option>
                        <option value="5">5 - Routine</option>
                    </select>
                </div>

               
                <div class="col-md-3">
                    <label class="form-label small text-muted mb-1">Search by Location</label>
                    <input type="text" class="form-control form-control-sm" id="searchLocation" placeholder="Type area or location..." />
                </div>

                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-outline-danger btn-sm w-100 btn-clear" id="clearFilters">
                        Clear Filters
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">ID</th>
                            <th>DESCRIPTION</th>
                            <th>LOCATION</th>
                            <th>CATEGORY</th>
                            <th>SUBMITTED AT</th>
                            <th>STATUS</th>
                            <th>PRIORITY</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTable">
                        <tr>
                            <td colspan="7" class="text-center py-5 empty-state">
                                No requests submitted yet. Be the first!
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'serviceRequests';
        function loadRepo() { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { requests: [] }; }
        window.repo = loadRepo();

        if (!window.repo.getAllSorted) {
            window.repo.getAllSorted = () => [...window.repo.requests].sort((a, b) => a.priority - b.priority);
        }

        function renderTable() {
            const tbody = document.getElementById('requestsTable');
            if (!tbody) return;

            const catFilter = document.getElementById('filterCategory').value;
            const priFilter = document.getElementById('filterPriority').value;
            const locSearch = document.getElementById('searchLocation').value.trim().toLowerCase(); 

            let data = window.repo.getAllSorted();

            if (catFilter) data = data.filter(r => r.category === catFilter);
            if (priFilter) data = data.filter(r => r.priority === +priFilter);
            if (locSearch) data = data.filter(r => r.location && r.location.toLowerCase().includes(locSearch)); 

            tbody.innerHTML = data.length === 0
                ? `<tr><td colspan="7" class="text-center py-5 empty-state">
                     ${catFilter || priFilter || locSearch ? 'No requests match your filters.' : 'No requests submitted yet. Be the first!'}
                   </td></tr>`
                : data.map(r => `
                    <tr>
                        <td class="ps-4"><code>${r.id}</code></td>
                        <td class="text-truncate" style="max-width: 250px;">${r.description}</td>
                        <td class="text-truncate">${r.location || '-'}</td> <!-- ✅ Location column -->
                        <td><span class="badge bg-light text-dark">${r.category}</span></td>
                        <td class="small text-muted">${r.submittedAt}</td>
                        <td><span class="badge bg-secondary">${r.status}</span></td>
                        <td><span class="badge ${r.priority <= 2 ? 'bg-danger' : 'bg-warning'} text-white">P${r.priority}</span></td>
                    </tr>
                `).join('');
        }

        document.getElementById('filterCategory').onchange = renderTable;
        document.getElementById('filterPriority').onchange = renderTable;
        document.getElementById('searchLocation').oninput = renderTable; 
        document.getElementById('clearFilters').onclick = () => {
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterPriority').value = '';
            document.getElementById('searchLocation').value = '';
            renderTable();
        };

        renderTable();
        setInterval(renderTable, 5000);
    </script>
</body>
</html>
